# Scalingo Operator

Scalingo operator for Kubernetes.


# Usage

TODO: to complete

## Create secret

```sh
# create secret
export SCALINGO_TOKEN="tk-my_token"
kubectl create secret generic scalingo \
    --from-literal=api_token="$SCALINGO_TOKEN"

# verification
kubectl describe secret scalingo
```

## Apply

kubectl apply -k config/samples

or

kubectl apply -f config/samples/databases_v1alpha1_postgresql.yaml

TODO: to complete


# Architecture

This application follows a (slightly adapted version of) the [clean architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html) pattern.

![Operator clean code architecture](./doc/operator_clean_architecture.svg)

## Layers

* `Boundaries` > `Out`: output calls to [go-scalingo](https://github.com/Scalingo/go-scalingo) API
* `Controler` (> `In`): handles input Kubernetes requests
* `Usecases`: business rules
* `Domain`: business entities

## Note

`Controler` is generated by `Kubebuilder`, ready to handle Kubernetes requests.
For this reason it is kept as is, ensuring the `Controlers` **plus** the `Boundaries > In` layers.

# Development

## Install Environment

```sh
sudo snap install microk8s --classic
sudo snap install kubectl --classic


microk8s.kubectl config view --raw > $HOME/.kube/microk8s.config

# then add in ~/.zshrc
export  KUBECONFIG=$HOME/.kube/config
export  KUBECONFIG=$KUBECONFIG:$HOME/.kube/microk8s.config

# verification: both commands must return the same informations
microk8s.kubectl config view
kubectl config view
```

<<<<<<< HEAD
## Download Kubebuilder and Install Locally
=======
## download kubebuilder and install locally
>>>>>>> c61f6f0 (doc: explain architecture in use)
```sh
curl -L -o kubebuilder "https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)"
chmod +x kubebuilder && sudo mv kubebuilder /usr/local/bin/
```

## Kubebuilder Commands

### Operator Creation Example
```sh
kubebuilder init --domain scalingo.com --repo github.com/Scalingo/scalingo-operator
kubebuilder create api --group databases --version v1alpha1 --kind PostgreSQL
kubebuilder create api --group databases --version v1alpha1 --kind OpenSearch
make manifests
make generate
make install
```

### Build Commands

```sh
# generate api/v1alpha/zz_generated.deepcopy.go
make generate

# generate the CRD manifests under config/crd/bases and a sample for it under config/samples
make manifests
```

### Execute command

```sh
# deploy the CRD on local cluster
make install

# verify using
kubectl get crd

# execute
make run
```

<<<<<<< HEAD
### Deployment Commands

=======
### Build and deploy image
>>>>>>> c61f6f0 (doc: explain architecture in use)
```sh
export VERSION="1.0.0-alpha1"

# build and push your image to the location specified by IMG
make docker-build docker-push IMG=scalingo/scalingo-operator:v$VERSION

# deploy the controller to the cluster with image specified by IMG
make deploy IMG=scalingo/scalingo-operator:v$VERSION
```

# Useful links

* [Kubebuilder book](https://book.kubebuilder.io/)
* [MicroK8s](https://microk8s.io/)
* [Kubernetes operator](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/)
* [Kubernetes Custom Resource Definition](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/)
