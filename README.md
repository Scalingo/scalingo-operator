# Scalingo Operator

Scalingo operator for Kubernetes.

# Definitions

Few helpful definitions to start with.

## CRD (Custom Resource Definition)

A CRD is a Kubernetes object used to define a new custom resource type in the Kubernetes API.
It tells the API server: “Here is a new kind (e.g., MyApp) and its schema.”

Example:
`config/crd/bases/databases.scalingo.com_postgresqls.yaml`

## CR (Custom Resource)

A CR is an actual instance of the type defined by the CRD.

Example:
`config/samples/databases_v1alpha1_postgresql.yaml`

# Usage

As a pre-requisite, first store your Scalingo API token in your cluster secrets.
Then, execute the Kubernetes operator on your cluster.

## Create Secret

```sh
# create secret
export SCALINGO_TOKEN="tk-my_token"
kubectl create secret generic scalingo \
    --from-literal=api_token="$SCALINGO_TOKEN"

# verification
kubectl describe secret scalingo
```

## Deploy Database

Using PostgreSQL sample example:
```sh
kubectl apply -f config/samples/databases_v1alpha1_postgresql.yaml
```

### Read Database URL

At deployment, the database secret is written in Kubernetes secrets.
The secret `name` and `key` are defined in Custom Resource `connInfoSecretTarget` fields.

To read the secret:
```sh
$NAME=my-postgresql-secret  # read from CR spec.connInfoSecretTarget.name
$PREFIX=PG                     # read from CR spec.connInfoSecretTarget.prefix

# list all secrets in all namespaces
kubectl get secrets -A

# secret details
kubectl describe secret $NAME

# get secret field
kubectl get secret $NAME -o jsonpath='{.data}' | grep $PREFIX

# gather the returned base64 content and decode, example:
echo "eG94b3hveG8=" | base64 --decode
```

## Remove Database

Using PostgreSQL sample example:
```sh
kubectl delete -f config/samples/databases_v1alpha1_postgresql.yaml
```

# Architecture

This application follows a (slightly adapted version of) the [clean architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html) pattern.

![Operator clean code architecture](./doc/operator_clean_architecture.svg)

## Layers

* `Boundaries` > `Out`: output calls to [go-scalingo](https://github.com/Scalingo/go-scalingo) API
* `Controller` (> `In`): handles input Kubernetes requests
* `Usecases`: business rules
* `Domain`: business entities

## Note

`Controller` is generated by `Kubebuilder`, ready to handle Kubernetes requests.
For this reason it is kept as is, ensuring the `Controllers` **plus** the `Boundaries > In` layers.

# Development

## Install Environment

```sh
sudo snap install microk8s --classic
sudo snap install kubectl --classic


microk8s.kubectl config view --raw > $HOME/.kube/microk8s.config

# then add in ~/.zshrc
export  KUBECONFIG=$HOME/.kube/config
export  KUBECONFIG=$KUBECONFIG:$HOME/.kube/microk8s.config

# verification: both commands must return the same informations
microk8s.kubectl config view
kubectl config view
```

## Download Kubebuilder and Install Locally

```sh
curl -L -o kubebuilder "https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)"
chmod +x kubebuilder && sudo mv kubebuilder /usr/local/bin/
```

## Kubebuilder Commands

### Operator Creation Example

These commands were executed to create this operator:

```sh
kubebuilder init --domain scalingo.com --repo github.com/Scalingo/scalingo-operator
kubebuilder create api --group databases --version v1alpha1 --kind PostgreSQL
kubebuilder create api --group databases --version v1alpha1 --kind OpenSearch
make manifests
make generate
make install
```

### Build Commands

```sh
# generate api/v1alpha/zz_generated.deepcopy.go
make generate

# generate the CRD manifests under config/crd/bases and a sample for it under config/samples
make manifests

# note: they can be combined
make generate manifests
```

### Execute Command

```sh
# deploy the CRD on local cluster
make install

# verify using
kubectl get crd

# execute
make run
```

### Build and Deploy Image
```sh
export VERSION="1.0.0-alpha1"

# build and push your image to the location specified by IMG
make docker-build docker-push IMG=scalingo/scalingo-operator:v$VERSION

# deploy the controller to the cluster with image specified by IMG
make deploy IMG=scalingo/scalingo-operator:v$VERSION
```

## Tips and Tricks

### Force delete the CRD

In case the kubernetes delete CRD hangs indefinetly, as with such command:
```sh
kubectl delete crd postgresqls.databases.scalingo.com
```

to force the deletion, remove the Finalizers manually:
```sh
# example
$KIND=PostgreSQL
$NAME=postgresql-sample
$CRD=postgresqls.databases.scalingo.com

# edit the current CRD descriptor, and remove this block:
#
#   metadata:
#       finalizers: []
#
kubectl edit $KIND $NAME

# then, retry the delete
kubectl delete crd $CRD
```

# Useful Links

* [Kubebuilder book](https://book.kubebuilder.io/)
* [MicroK8s](https://microk8s.io/)
* [Kubernetes operator](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/)
* [Kubernetes Custom Resource Definition](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/)
